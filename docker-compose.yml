version: "3"
services:
  airflow-webserver:
    container_name: airflow_container
    image: 'puckel/docker-airflow:1.10.9'
    ports:
      - '8085:8080'
    networks:
      - dataworld
    volumes:
      - ./airflow/logs:/usr/local/airflow/logs
      - ./airflow/dags:/usr/local/airflow/dags
      - ./airflow/requirements/requirements.txt:/requirements.txt
      - ./airflow/airflow.cfg:/usr/local/airflow/airflow.cfg
    environment:
      - GUNICORN_CMD_ARGS=--log-level warning
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/admin/"]
      interval: 30s
      timeout: 20s
      retries: 3

  zookeeper:
    container_name: zookeeper_container
    image: 'bitnami/zookeeper:3.8'
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    networks:
      - dataworld
    restart: always

  nifi:
    container_name: nifi_container
    image: 'apache/nifi:1.18.0'
    ports:
      - '8091:8080'
    networks:
      - dataworld
    volumes:
      - ./nifi/jdbc:/opt/nifi/nifi-current/jdbc
      - ./nifi/credentials:/opt/nifi/nifi-current/credentials
      - ./nifi/logback.xml:/opt/nifi/nifi-current/conf/logback.xml
    environment:
      - NIFI_WEB_HTTP_PORT=8080
      - NIFI_CLUSTER_IS_NODE=true
      - NIFI_CLUSTER_NODE_PROTOCOL_PORT=8082
      - NIFI_ZK_CONNECT_STRING=zookeeper_container:2181
      - NIFI_SENSITIVE_PROPS_KEY=12345678901234567890A
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/nifi/"]
      interval: 30s
      timeout: 20s
      retries: 3

  registry:
    container_name: registry_container
    image: 'apache/nifi-registry:1.14.0'
    ports:
      - '18080:18080'
    environment:
      - LOG_LEVEL=ERROR
    volumes:
      - ./nifi_registry/database:/opt/nifi-registry/nifi-registry-current/database
      - ./nifi_registry/flow_storage:/opt/nifi-registry/nifi-registry-current/flow_storage
    networks:
      - dataworld
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18080/nifi-registry/"]
      interval: 30s
      timeout: 20s
      retries: 3

  postgres:
    container_name: postgres_container
    image: 'postgres:14'
    environment:
      POSTGRES_USER: 'postgres'
      POSTGRES_PASSWORD: 'postgres'
      PGDATA: /data/postgres
    volumes:
      - postgres:/data/postgres
    ports:
      - '5432:5432'
    networks:
      - dataworld
    restart: on-failure

  pgadmin:
    container_name: pgadmin_container
    image: 'dpage/pgadmin4:6.1'
    environment:
      PGADMIN_DEFAULT_EMAIL: 'pgadmin4@pgadmin.org'
      PGADMIN_DEFAULT_PASSWORD: 'admin'
    volumes:
      - pgadmin:/var/lib/pgadmin
    ports:
      - '5050:80'
    networks:
      - dataworld
    restart: on-failure

  minio:
    container_name: minio_container
    image: 'bitnami/minio:2021.11.24'
    environment:
      MINIO_ROOT_USER: minio_admin
      MINIO_ROOT_PASSWORD: minio_password
    ports:
      - '9000:9000'
      - '9001:9001'
    volumes:
      - './minio/data:/data'
    networks:
      - dataworld
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  portainer:
    image: 'portainer/portainer-ce:2.11.1'
    container_name: portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    ports:
      - '9009:9000'
    networks:
      - dataworld

volumes:
  airflow-data:
  postgres:
  pgadmin:
  portainer-data:

networks:
  dataworld:
    driver: bridge
